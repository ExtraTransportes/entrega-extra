<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Extra Transportes</title>
  <style>
    body{font-family:Arial;background:#f8f9fa;margin:0;padding:20px;text-align:center}
    .c{background:#fff;max-width:420px;margin:auto;padding:30px;border-radius:25px;box-shadow:0 15px 40px rgba(0,0,0,.2)}
    .logo{width:280px;margin:20px auto;display:block}
    input,button{width:90%;padding:16px;margin:12px auto;display:block;border-radius:12px;border:2px solid #007bff;font-size:18px;box-sizing:border-box}
    button{background:#007bff;color:#fff;font-weight:bold;cursor:pointer}
    .fotos{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:15px 0}
    .foto-prev{width:100px;height:100px;object-fit:cover;border-radius:10px;border:2px solid #007bff;position:relative}
    .remover{position:absolute;top:5px;right:5px;background:red;color:white;border-radius:50%;width:20px;height:20px;font-size:12px;line-height:20px;cursor:pointer}
    #progress-container{width:90%;height:20px;background:#ddd;border-radius:10px;margin:15px auto;overflow:hidden;display:none}
    #progress-bar{height:100%;width:0;background:#007bff;transition:width 0.3s}
    #ok{margin-top:15px;font-weight:bold;color:green}
    h2{color:#007bff}
    .camera-actions{margin-top:10px;display:flex;gap:10px;justify-content:center}
    .camera-actions button{width:48%;padding:14px;font-size:16px}
  </style>
</head>
<body>
  <div class="c">
    <img src="logo.png" alt="Extra Transportes" class="logo" onerror="this.style.display='none'">
    <h2>Comprovante de Entrega</h2>
    <input type="text" id="motorista" placeholder="Nome do Motorista" required>
    <input type="text" id="nota" placeholder="Número da Nota/CT-e" required>
    <input type="text" id="placa" placeholder="Placa (ex: ABC1D23)" maxlength="7" required>
    <button onclick="iniciar()">Iniciar Comprovante</button>
    <div class="fotos" id="fotos"></div>
    <div id="progress-container"><div id="progress-bar"></div></div>
    <button onclick="enviar()" id="env" style="display:none">Enviar para Transportadora</button>
    <p id="ok"></p>
  </div>

  <script>
    let fotos = [], lat = null, lng = null, gpsPronto = false;

    // Validação de placa
    document.getElementById('placa').addEventListener('input', function(e) {
      let v = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
      if (v.length > 7) v = v.slice(0,7);
      e.target.value = v;
    });

    function validarPlaca(placa) {
      const padrao1 = /^[A-Z]{3}\d[A-Z]\d{2}$/;
      const padrao2 = /^[A-Z]{3}\d{4}$/;
      return padrao1.test(placa) || padrao2.test(placa);
    }

    function iniciar() {
      const motorista = document.getElementById('motorista').value.trim();
      const n = document.getElementById('nota').value.trim();
      const placa = document.getElementById('placa').value.trim();
      if (!motorista || !n || !placa) return alert("Preencha todos os campos!");
      if (!validarPlaca(placa)) return alert("Placa inválida! Use ABC1D23 ou ABC1234");

      if (!gpsPronto) {
        if (!navigator.geolocation) return alert("GPS não disponível");
        navigator.geolocation.getCurrentPosition(pos => {
          lat = pos.coords.latitude.toFixed(6);
          lng = pos.coords.longitude.toFixed(6);
          gpsPronto = true;
          tirarFoto();
        }, () => alert("Permita o GPS!"));
      } else {
        tirarFoto();
      }
    }

    function tirarFoto() {
      const i = document.createElement('input');
      i.type = 'file'; i.accept = 'image/*'; i.capture = 'environment';
      i.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          const div = document.createElement('div');
          div.className = 'foto-prev';
          const img = document.createElement('img');
          img.src = ev.target.result;
          img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover';
          const remover = document.createElement('div');
          remover.textContent = '×';
          remover.className = 'remover';
          remover.onclick = () => {
            fotos = fotos.filter(f => f !== file);
            div.remove();
            atualizarBotao();
          };
          div.appendChild(img);
          div.appendChild(remover);
          document.getElementById('fotos').appendChild(div);
          fotos.push(file);
          mostrarOpcoesCamera();
        };
        reader.readAsDataURL(file);
      };
      i.click();
    }

    function mostrarOpcoesCamera() {
      const existente = document.querySelector('.camera-actions');
      if (existente) existente.remove();

      const actions = document.createElement('div');
      actions.className = 'camera-actions';
      const btnMais = document.createElement('button');
      btnMais.textContent = 'Adicionar Mais';
      btnMais.onclick = tirarFoto;
      const btnEnviar = document.createElement('button');
      btnEnviar.textContent = 'Enviar Tudo';
      btnEnviar.onclick = () => {
        actions.remove();
        enviar();
      };
      actions.appendChild(btnMais);
      actions.appendChild(btnEnviar);
      document.getElementById('fotos').appendChild(actions);
      atualizarBotao();
    }

    function atualizarBotao() {
      document.getElementById('env').style.display = fotos.length > 0 ? 'block' : 'none';
    }

    function enviar(){
      document.getElementById('progress-container').style.display = 'block';
      document.getElementById('ok').innerHTML = "Enviando...";
      let enviadas = 0;
      const total = fotos.length;

      fotos.forEach((foto, i) => {
        const r = new FileReader();
        r.onload = () => {
          const b = r.result.split(',')[1];
          const dados = {
            nota: document.getElementById('nota').value,
            placa: document.getElementById('placa').value,
            motorista: document.getElementById('motorista').value,
            lat: lat,
            lng: lng,
            nome: `${document.getElementById('nota').value}_${i+1}_${new Date().toISOString().slice(0,10)}.jpg`,
            file: b
          };
          fetch('https://script.google.com/macros/s/AKfycbysbdJhLZKSeN1mCqc6rW4Um6x3iLn161euJPl7GyNo0s_OAfwuHlFMxpMlu_Wbo27D/exec',{
            method:'POST',
            body:JSON.stringify(dados),
            headers:{'Content-Type':'text/plain'}
          })
          .then(() => {
            enviadas++;
            document.getElementById('progress-bar').style.width = (enviadas/total*100) + '%';
            if (enviadas === total) {
              document.getElementById('ok').innerHTML="Tudo enviado! Abrindo WhatsApp...";
              const msg = `Entrega ${dados.nota} com ${total} foto(s)!\nMotorista: ${dados.motorista}\nPlaca: ${dados.placa}\nLocal: https://maps.google.com/?q=${lat},${lng}`;
              window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
              setTimeout(()=>location.reload(),3000);
            }
          })
          .catch(() => alert("Erro ao enviar foto " + (i+1)));
        };
        r.readAsDataURL(foto);
      });
    }
  </script>
</body>
</html>
